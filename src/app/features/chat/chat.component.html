<div *ngIf="!isBlockedByViewer" class="chat-wrapper" [class.dark-mode]="isDarkMode">
  <!-- HEADER -->
  <div class="chat-header">
    <div class="recipient-info" *ngIf="recipientUser">
      <img
        [src]="recipientUser.profileImageUrl || 'https://i.pravatar.cc/150?u=' + recipientUser.username"
        alt="Avatar"
        class="avatar"
      />
      <div class="details">
        <div class="username">
          {{ recipientUser.username }}
          <svg *ngIf="recipientUser.premiumUser" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="16px" height="16px"><polygon fill="#42a5f5" points="29.62,3 33.053,8.308 39.367,8.624 39.686,14.937 44.997,18.367 42.116,23.995 45,29.62 39.692,33.053 39.376,39.367 33.063,39.686 29.633,44.997 24.005,42.116 18.38,45 14.947,39.692 8.633,39.376 8.314,33.063 3.003,29.633 5.884,24.005 3,18.38 8.308,14.947 8.624,8.633 14.937,8.314 18.367,3.003 23.995,5.884"/><polygon fill="#fff" points="21.396,31.255 14.899,24.76 17.021,22.639 21.428,27.046 30.996,17.772 33.084,19.926"/></svg>
        </div>
        <div class="status">
          <span *ngIf="isRecipientTyping" class="typing">Typing...</span>
          <ng-container *ngIf="!isRecipientTyping">
            <span *ngIf="isRecipientOnline" class="online">â— Online</span>
            <span *ngIf="!isRecipientOnline" class="offline">â— Offline</span>
          </ng-container>
        </div>
      </div>
    </div>

    <button class="theme-toggle" (click)="toggleTheme()">
      {{ isDarkMode ? 'ğŸŒ™' : 'â˜€ï¸' }}
    </button>
    <button (click)="startCall()">Call</button>
  </div>

  <!-- MESSAGES -->
  <div class="messages" #messagesContainer (scroll)="onScroll($event)">
    <div
      *ngFor="let msg of messages"
      class="message-row"
      [ngClass]="{'sent': msg.senderId === currentUser?.id, 'received': msg.senderId !== currentUser?.id}"
    >
      <img
        *ngIf="msg.senderId !== currentUser?.id"
        [src]="msg.senderProfileImageUrl || 'https://i.pravatar.cc/150?u=' + msg.senderUsername"
        class="message-avatar"
        alt="User"
      />

<div class="message-bubble" [attr.data-message-id]="msg.id"
     (mouseenter)="onMessageHover(msg, $event)"
     (mouseleave)="onMessageLeave()">        
  <div class="sender-name" *ngIf="msg.senderId !== currentUser?.id">
          {{ msg.senderFirstName }} {{ msg.senderLastName }}
        </div>

        <div class="content" (click)="onMessageClick(msg)">
          <ng-container [ngSwitch]="msg.messageType">
            <ng-container *ngSwitchCase="MessageType.POST_LINK">
              <div *ngIf="msg.post" class="post-preview">
                <i>{{ msg.senderUsername }} sent a post</i>
                <img [src]="msg.post.mediaUrl" alt="Post image">
                <p>{{ msg.post.content }}</p>
              </div>
            </ng-container>
            <ng-container *ngSwitchCase="MessageType.REEL_LINK">
              <div *ngIf="msg.reel" class="reel-preview">
                <i> {{ msg.senderUsername }} sent a reel</i>
                <video [src]="msg.reel.mediaVideoUrl" alt="Reel video" autoplay muted loop controlsList="nodownload nofullscreen noremoteplayback"></video>
                <!-- <p>{{ msg.reel.caption }}</p> -->
              </div>
            </ng-container>
            <ng-container *ngSwitchCase="MessageType.PROFILE_LINK">
              <div *ngIf="msg.user" class="user-preview">
                <img [src]="msg.user.profileImageUrl || 'https://i.pravatar.cc/150?u=' + msg.user.id" alt="User image">
                <div>
                  <p>{{ msg.user.firstName }} {{ msg.user.lastName }}</p>
                  
                  <p>@{{ msg.user.username }}
                  <svg *ngIf="msg.user.premiumUser" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="20px" height="20px"><polygon fill="#42a5f5" points="29.62,3 33.053,8.308 39.367,8.624 39.686,14.937 44.997,18.367 42.116,23.995 45,29.62 39.692,33.053 39.376,39.367 33.063,39.686 29.633,44.997 24.005,42.116 18.38,45 14.947,39.692 8.633,39.376 8.314,33.063 3.003,29.633 5.884,24.005 3,18.38 8.308,14.947 8.624,8.633 14.937,8.314 18.367,3.003 23.995,5.884"/><polygon fill="#fff" points="21.396,31.255 14.899,24.76 17.021,22.639 21.428,27.046 30.996,17.772 33.084,19.926"/></svg>
                </p>
                </div>
              </div>
            </ng-container>
            <ng-container *ngSwitchDefault>
              {{ msg.content }}
            </ng-container>
          </ng-container>
        </div>

        <!-- Reactions -->
        <div class="reactions" *ngIf="msg.reactions?.length">
          <span *ngFor="let r of msg.reactions">{{ r.reaction }}</span>
        </div>

        <div class="meta">
          <span class="time">{{ msg.sentAt | date: 'shortTime' }}</span>
          <span *ngIf="msg.senderId === currentUser?.id">
            <i *ngIf="!msg.seen" class="fa fa-check"></i>
            <i *ngIf="msg.seen" class="fa fa-check-double seen"></i>
          </span>
        </div>

        <!-- Action buttons -->
        <div class="actions">
          <button (click)="toggleEmojiPicker(msg)">ğŸ˜Š</button>
          <button *ngIf="msg.senderId === currentUser?.id" (click)="unsendMessage(msg.id)">âª</button>
          <button *ngIf="msg.senderId === currentUser?.id" (click)="deleteMessageForMe(msg.id)">ğŸ—‘ï¸</button>
        </div>

        <!-- Emoji Picker -->
        <div *ngIf="msg.showEmojiPicker" class="emoji-picker">
          <span
            *ngFor="let emoji of availableEmojis"
            (click)="reactToMessage(msg.id, emoji)"
            >{{ emoji }}</span
          >
        </div>
      </div>

      <img
        *ngIf="msg.senderId === currentUser?.id"
        [src]="msg.senderProfileImageUrl || 'https://i.pravatar.cc/150?u=' + msg.senderUsername"
        class="message-avatar"
        alt="Me"
      />
    </div>

    <!-- Typing Dots -->
    <div *ngIf="isRecipientTyping" class="typing-dots">
      <span></span><span></span><span></span>
    </div>
  </div>

  <!-- INPUT -->
  <div class="chat-input">
    <input
      type="text"
      [(ngModel)]="newMessageContent"
      placeholder="Message..."
      (focus)="onTyping()"
      (blur)="onBlur()"
      (keyup.enter)="sendMessage()"
    />
    <label *ngIf="premiumUser"  class="switch">
      <input title="pvt" type="checkbox" [checked]="isAiFeatureEnabled" (change)="onAiToggleChange($event)">
      <span class="slider round"></span>
    </label>
    <button *ngIf="premiumUser && isAiFeatureEnabled" (click)="generateAiReply()" [disabled]="!isAiFeatureEnabled || isGeneratingReply" class="ai-reply-button">
      <span *ngIf="!isGeneratingReply">ğŸ¤– AI Reply</span>
      <span *ngIf="isGeneratingReply">Generating...</span>
    </button>
    <button class="send-btn" (click)="sendMessage()">â¤</button>
  </div>
</div>
 <div *ngIf="isBlockedByViewer" class="blocked-profile-message">
    <p>Unable to open this chat.</p>
    <p>You are blocked by this user.</p>
  </div>

<canvas id="confetti-canvas"></canvas>
